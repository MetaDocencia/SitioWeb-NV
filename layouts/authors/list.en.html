{{ define "main" }}
{{/* Localizar sitios por idioma */}}
{{ $siteES := .Site }}
{{ range .Sites }}{{ if eq .Language.Lang "es" }}{{ $siteES = . }}{{ end }}{{ end }}

{{/* Slug base del autor */}}
{{ $slug := "" }}
{{ if .File }}
  {{ $slug = ( .File.Dir | strings.TrimSuffix "/" | path.Base ) }}
{{ else }}
  {{ $slug = ( .RelPermalink | strings.TrimSuffix "/" | path.Base ) }}
{{ end }}

{{/* Página ES (contraparte canónica) */}}
{{ $pageES := $siteES.GetPage (printf "authors/%s" $slug) }}

{{/* Metadatos: en EN tomamos Params/Resources desde ES si existe (salvo campos priorizados) */}}
{{ $meta := . }}
{{ if $pageES }}{{ $meta = $pageES }}{{ end }}

{{/* Avatar */}}
{{ $avatar := cond (ne $meta.File nil) ($meta.Resources.GetMatch "avatar*") nil }}
{{ $avatarURL := cond $avatar $avatar.RelPermalink (printf "/authors/%s/avatar.png" $slug) }}

<article class="container mx-auto max-w-4xl px-6 md:px-10 xl:px-12 py-6 text-gray-900 dark:text-white">

  <!-- Estilo local para forzar círculo perfecto del avatar -->
  <style>
    .author-avatar {
      position: relative;
      width: 10rem;   /* 160px ~ w-40 */
      height: 10rem;  /* cuadrado → círculo perfecto al redondear */
      border-radius: 9999px;
      overflow: hidden;
      flex-shrink: 0;
    }
    @media (min-width: 768px) {
      .author-avatar { width: 15rem; height: 15rem; } /* 240px ~ md:w-60 md:h-60 */
    }
    .author-avatar > img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;   /* llena sin deformar */
      object-position: center;
      display: block;
    }
  </style>

  <header class="mb-6 flex flex-col md:flex-row items-start md:items-center gap-5 md:gap-6">
    <div class="w-full md:w-auto flex md:block justify-center">
      <div class="author-avatar">
        <img src="{{ $avatarURL }}" alt="{{ .Title }}" loading="lazy">
      </div>
    </div>

    <div class="w-full">
      <h1 class="text-3xl font-extrabold tracking-tight">{{ .Title }}</h1>

      {{/* ==== AJUSTE: role prioriza EN y cae a ES ==== */}}
      {{ $role := .Params.role }}
      {{ if not $role }}{{ $role = $meta.Params.role }}{{ end }}
      {{ with $role }}<p class="text-sm opacity-80 mt-0.5">{{ . }}</p>{{ end }}

      {{ with $meta.Params.organizations }}{{ range first 1 . }}{{ with .name }}<p class="text-sm opacity-80">{{ . }}</p>{{ end }}{{ end }}{{ end }}
      {{ with $meta.Params.email }}<p class="text-sm mt-2"><a href="mailto:{{ . }}" class="underline break-all hover:no-underline">{{ . }}</a></p>{{ end }}

      {{ $socials := $meta.Params.social }}
      {{ if $socials }}
        {{ $labels := dict "twitter" "Twitter" "x-twitter" "Twitter" "github" "GitHub" "bluesky" "Bluesky" "linkedin" "LinkedIn" "mastodon" "Mastodon" "orcid" "ORCID" "globe" "Website" "home" "Website" "envelope" "Email" }}
        <p class="text-sm mt-1 flex flex-wrap items-center gap-x-3 gap-y-1">
          <span class="font-medium mr-1">{{ i18n "contact" | default "Contact:" }}</span>
          {{ $items := slice }}
          {{ range $socials }}
            {{ $icon := ( .icon | lower ) }}{{ $pack := ( .icon_pack | lower ) }}{{ $url := .link }}
            {{ $label := cond (isset $labels $icon) (index $labels $icon) (title $icon) }}
            {{ $faPack := cond (eq $pack "fab") "fab" (cond (eq $pack "fas") "fas" "fab") }}
            {{ $one := printf `<a href="%s" target="_blank" rel="noopener" class="inline-flex items-center gap-1 underline hover:no-underline"><i class="%s fa-%s" aria-hidden="true"></i><span>%s</span></a>` $url $faPack $icon $label }}
            {{ $items = $items | append $one }}
          {{ end }}
          {{ delimit $items " · " | safeHTML }}
        </p>
      {{ end }}

      {{/* ==== interests: EN primero, luego ES ==== */}}
      {{ $interests := .Params.interests }}
      {{ if not $interests }}{{ $interests = $meta.Params.interests }}{{ end }}
      {{ with $interests }}
        <p class="text-sm opacity-90 mt-1"><span class="font-medium">{{ i18n "interests" | default "Interests:" }}</span> {{ delimit . " · " }}</p>
      {{ end }}

      {{/* ==== education: EN primero, luego ES ==== */}}
      {{ $edu := .Params.education
