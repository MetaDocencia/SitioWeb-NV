{{ define "main" }}

{{/* ========= Slug del autor ========= */}}
{{ $slug := "" }}
{{ if .File }}
  {{ $slug = ( .File.Dir | strings.TrimSuffix "/" | path.Base ) }}
{{ else }}
  {{ $slug = ( .RelPermalink | strings.TrimSuffix "/" | path.Base ) }}
{{ end }}

{{/* ========= Contraparte ES por .Translations ========= */}}
{{ $pageES := nil }}
{{ range .Translations }}
  {{ if eq .Lang "es" }}
    {{ $pageES = . }}
  {{ end }}
{{ end }}

{{/* ========= Fallback helpers (EN primero, luego ES) ========= */}}
{{/* role */}}
{{ $role := .Params.role }}
{{ if not $role }}
  {{ with $pageES }}
    {{ with .Params.role }}
      {{ $role = . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* organization (primer nombre) */}}
{{ $orgName := "" }}
{{ with .Params.organizations }}
  {{ range first 1 . }}
    {{ with .name }}
      {{ $orgName = . }}
    {{ end }}
  {{ end }}
{{ end }}
{{ if eq $orgName "" }}
  {{ with $pageES }}
    {{ with .Params.organizations }}
      {{ range first 1 . }}
        {{ with .name }}
          {{ $orgName = . }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* email */}}
{{ $email := .Params.email }}
{{ if not $email }}
  {{ with $pageES }}
    {{ with .Params.email }}
      {{ $email = . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* social */}}
{{ $socials := .Params.social }}
{{ if not $socials }}
  {{ with $pageES }}
    {{ $socials = .Params.social }}
  {{ end }}
{{ end }}

{{/* interests */}}
{{ $interests := .Params.interests }}
{{ if not $interests }}
  {{ with $pageES }}
    {{ $interests = .Params.interests }}
  {{ end }}
{{ end }}

{{/* education.courses */}}
{{ $courses := slice }}
{{ with .Params.education }}
  {{ with .courses }}
    {{ $courses = . }}
  {{ end }}
{{ end }}
{{ if eq (len $courses) 0 }}
  {{ with $pageES }}
    {{ with .Params.education }}
      {{ with .courses }}
        {{ $courses = . }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* ========= Avatar único (mismo para ES/EN) ========= */}}
{{ $avatarURL := printf "/authors/%s/avatar.png" $slug }}

<article class="container mx-auto max-w-4xl px-6 md:px-10 xl:px-12 py-6 text-gray-900 dark:text-white">
  <header class="mb-6 flex flex-col md:flex-row items-start md:items-center gap-5 md:gap-6">
    <div class="w-full md:w-auto flex md:block justify-center">
      <img src="{{ $avatarURL }}" alt="{{ .Title }}" class="w-40 h-40 md:w-60 md:h-60 rounded-full object-cover" loading="lazy">
    </div>

    <div class="w-full">
      <h1 class="text-3xl font-extrabold tracking-tight">{{ .Title }}</h1>

      {{ if $role }}
        <p class="text-sm opacity-80 mt-0.5">{{ $role }}</p>
      {{ end }}

      {{ if $orgName }}
        <p class="text-sm opacity-80">{{ $orgName }}</p>
      {{ end }}

      {{ if $email }}
        <p class="text-sm mt-2">
          <a href="mailto:{{ $email }}" class="underline break-all hover:no-underline">{{ $email }}</a>
        </p>
      {{ end }}

      {{ if $socials }}
        {{ $labels := dict "twitter" "Twitter" "x-twitter" "Twitter" "github" "GitHub" "bluesky" "Bluesky" "linkedin" "LinkedIn" "mastodon" "Mastodon" "orcid" "ORCID" "globe" "Website" "home" "Website" "envelope" "Email" }}
        <p class="text-sm mt-1 flex flex-wrap items-center gap-x-3 gap-y-1">
          <span class="font-medium mr-1">{{ i18n "contact" | default "Contact:" }}</span>
          {{ $items := slice }}
          {{ range $socials }}
            {{ $icon := ( .icon | lower ) }}
            {{ $pack := ( .icon_pack | lower ) }}
            {{ $url  := .link }}
            {{ $label := cond (isset $labels $icon) (index $labels $icon) (title $icon) }}
            {{ $faPack := cond (eq $pack "fab") "fab" (cond (eq $pack "fas") "fas" "fab") }}
            {{ $one := printf `<a href="%s" target="_blank" rel="noopener" class="inline-flex items-center gap-1 underline hover:no-underline"><i class="%s fa-%s" aria-hidden="true"></i><span>%s</span></a>` $url $faPack $icon $label }}
            {{ $items = $items | append $one }}
          {{ end }}
          {{ delimit $items " · " | safeHTML }}
        </p>
      {{ end }}

      {{ if $interests }}
        <p class="text-sm opacity-90 mt-1">
          <span class="font-medium">{{ i18n "interests" | default "Interests:" }}</span>
          {{ delimit $interests " · " }}
        </p>
      {{ end }}

      {{ if $courses }}
        <div class="text-sm mt-2">
          <p class="font-medium mb-1">{{ i18n "education" | default "Education:" }}</p>
          <ul class="list-disc list-inside space-y-0.5">
            {{ range $courses }}
              <li>
                {{ with .course }}{{ . }}{{ end }}
                {{ if or .institution .year }}
                  {{ if .institution }} – {{ .institution }}{{ end }}
                  {{ if .year }} ({{ .year }}){{ end }}
                {{ end }}
              </li>
            {{ end }}
          </ul>
        </div>
      {{ end }}
    </div>
  </header>

  {{/* ========= Contenido: preferir EN; fallback a ES ========= */}}
  {{ $content := .Content }}
  {{ if eq (strings.TrimSpace $content) "" }}
    {{ with $pageES }}
      {{ $content = .Content }}
    {{ end }}
  {{ end }}
  <div class="prose dark:prose-invert max-w-none">
    {{ $content }}
  </div>

  {{/* ========= Blogposts del autor (matching flexible) ========= */}}
  {{ $name := "" }}
  {{ with .Params.name }}
    {{ $name = (lower .) }}
  {{ else }}
    {{ with $pageES }}
      {{ with .Params.name }}
        {{ $name = (lower .) }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $key := lower $slug }}
  {{ $keys := slice $key (lower .Title) $name }}

  {{ $col := slice }}
  {{ range where .Site.RegularPages "Type" "post" }}
    {{ $auth := .Params.authors }}
    {{ $hit := false }}
    {{ if $auth }}
      {{ $t := printf "%T" $auth }}
      {{ if eq $t "[]interface {}" }}
        {{ range $auth }}
          {{ $val := "" }}
          {{ if (eq (printf "%T" .) "map[string]interface {}") }}
            {{ if isset . "slug" }}{{ $val = lower (printf "%v" (index . "slug")) }}{{ end }}
            {{ if and (eq $val "") (isset . "name") }}{{ $val = lower (printf "%v" (index . "name")) }}{{ end }}
            {{ if and (eq $val "") (isset . "title") }}{{ $val = lower (printf "%v" (index . "title")) }}{{ end }}
          {{ else }}
            {{ $val = lower (printf "%v" .) }}
          {{ end }}
          {{ if in $keys $val }}
            {{ $hit = true }}
          {{ end }}
        {{ end }}
      {{ else if eq $t "string" }}
        {{ if in $keys (lower $auth) }}
          {{ $hit = true }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ if $hit }}
      {{ $col = $col | append . }}
    {{ end }}
  {{ end }}

  {{ $pages := sort $col "Date" "desc" }}
  {{ if gt (len $pages) 0 }}
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">{{ i18n "blogposts" | default "Blogposts" }}</h2>
      <ul class="list-disc list-inside space-y-1">
        {{ range $pages }}
          <li><a href="{{ .RelPermalink }}" class="underline hover:no-underline">{{ .Title }}</a></li>
        {{ end }}
      </ul>
    </section>
  {{ end }}
</article>

{{ end }}
