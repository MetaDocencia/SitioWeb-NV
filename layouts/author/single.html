{{ define "main" }}
<article class="container mx-auto px-4 py-6">

  {{/* ---------- Encabezado ---------- */}}
  <header class="mb-6 flex items-center gap-6">
    {{/* Intentar obtener avatar como Page Resource (si es bundle) */}}
    {{ $avatar := cond (ne .File nil) (.Resources.GetMatch "avatar*") nil }}

    {{/* Clave/slug de autor robusta:
         - si hay archivo, usar dir del bundle
         - si no, derivar del permalink (/authors/<slug>/)  */}}
    {{ $authorKey := "" }}
    {{ if .File }}
      {{ $authorKey = ( .File.Dir | strings.TrimSuffix "/" | path.Base ) }}
    {{ else }}
      {{ $authorKey = ( .RelPermalink | strings.TrimSuffix "/" | path.Base ) }}
    {{ end }}

    {{/* Avatar: 1.5x (240x240) */}}
    {{ if $avatar }}
      <img src="{{ $avatar.RelPermalink }}" alt="{{ .Title }}"
           class="w-60 h-60 rounded-full object-cover" loading="lazy">
    {{ else }}
      <img src="{{ printf "/authors/%s/avatar.png" $authorKey }}" alt="{{ .Title }}"
           class="w-60 h-60 rounded-full object-cover" loading="lazy">
    {{ end }}

    <div>
      <h1 class="text-3xl font-extrabold tracking-tight">{{ .Title }}</h1>
      {{ with .Params.role }}<p class="text-sm opacity-80 mt-0.5">{{ . }}</p>{{ end }}
      {{ with .Params.organizations }}
        {{ range first 1 . }}
          {{ with .name }}<p class="text-sm opacity-80">{{ . }}</p>{{ end }}
        {{ end }}
      {{ end }}

      {{/* Email */}}
      {{ with .Params.email }}
        <p class="text-sm mt-2">
          <a href="mailto:{{ . }}" class="underline">{{ . }}</a>
        </p>
      {{ end }}

      {{/* Redes sociales: "Contacto:" + íconos + texto */}}
      {{ $socials := .Params.social }}
      {{ if $socials }}
        {{ $labels := dict
          "twitter" "Twitter"
          "x-twitter" "Twitter"
          "github" "GitHub"
          "bluesky" "Bluesky"
          "linkedin" "LinkedIn"
          "mastodon" "Mastodon"
          "orcid" "ORCID"
          "globe" "Website"
          "home" "Website"
          "envelope" "Email"
        }}
        <p class="text-sm mt-1 flex flex-wrap items-center gap-x-3 gap-y-1">
          <span class="font-medium mr-1">Contacto:</span>
          {{ $items := slice }}
          {{ range $socials }}
            {{ $icon := ( .icon | lower ) }}
            {{ $pack := ( .icon_pack | lower ) }}
            {{ $url  := .link }}
            {{ $label := cond (isset $labels $icon) (index $labels $icon) (title $icon) }}
            {{ $faPack := cond (eq $pack "fab") "fab" (cond (eq $pack "fas") "fas" "fab") }}
            {{ $one := printf `<a href="%s" target="_blank" rel="noopener" class="inline-flex items-center gap-1 underline">
              <i class="%s fa-%s" aria-hidden="true"></i><span>%s</span>
            </a>` $url $faPack $icon $label }}
            {{ $items = $items | append $one }}
          {{ end }}
          {{ delimit $items " · " | safeHTML }}
        </p>
      {{ end }}

      {{/* Intereses con prefijo "Intereses:" */}}
      {{ with .Params.interests }}
        <p class="text-sm opacity-90 mt-1">
          <span class="font-medium">Intereses:</span> {{ delimit . " · " }}
        </p>
      {{ end }}

      {{/* Educación: courses (course – institution (year)) */}}
      {{ with .Params.education }}
        {{ with .courses }}
          <div class="text-sm mt-2">
            <p class="font-medium mb-1">Educación:</p>
            <ul class="list-disc list-inside space-y-0.5">
              {{ range . }}
                <li>
                  {{- with .course -}}{{ . }}{{ end -}}
                  {{- if or .institution .year -}}
                    {{- if .institution }} – {{ .institution }}{{ end -}}
                    {{- if .year }} ({{ .year }}){{ end -}}
                  {{- end -}}
                </li>
              {{ end }}
            </ul>
          </div>
        {{ end }}
      {{ end }}
    </div>
  </header>

  {{/* ---------- Contenido libre del autor ---------- */}}
  <div class="prose max-w-none">
    {{ .Content }}
  </div>

  {{/* ---------- Listado minimalista de posts del autor ---------- */}}
  {{/* Construimos claves posibles del autor para matchear en .Params.authors */}}
  {{ $keys := slice (lower $authorKey) (lower .Title) (lower (default "" .Params.name)) }}

  {{/* Secciones consideradas como "notas/blog" (ajustar si hace falta) */}}
  {{ $allowed := slice "post" "blog" "news" }}

  {{ $col := slice }}
  {{ range .Site.RegularPages }}
    {{/* Filtrar por secciones típicas de artículos */}}
    {{ if in $allowed .Section }}
      {{ $auth := .Params.authors }}
      {{ if $auth }}
        {{ $matched := false }}
        {{ $t := printf "%T" $auth }}
        {{ if eq $t "[]interface {}" }}
          {{/* Lista de autores */}}
          {{ range $auth }}
            {{ $a := lower (printf "%v" .) }}
            {{ if or (in $keys $a) (in $a (delimit $keys " ")) }}{{/* fallback defensivo */}}{{ end }}
            {{ if in $keys $a }}
              {{ $matched = true }}
            {{ end }}
          {{ end }}
        {{ else if eq $t "string" }}
          {{ if in $keys (lower $auth) }}
            {{ $matched = true }}
          {{ end }}
        {{ end }}
        {{ if $matched }}
          {{ $col = $col | append . }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $pages := sort $col "Date" "desc" }}

  {{ if gt (len $pages) 0 }}
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Blogpost</h2>
      <ul class="list-disc list-inside space-y-1">
        {{ range $pages }}
          <li><a href="{{ .RelPermalink }}" class="underline hover:no-underline">{{ .Title }}</a></li>
        {{ end }}
      </ul>
    </section>
  {{ end }}

</article>
{{ end }}
