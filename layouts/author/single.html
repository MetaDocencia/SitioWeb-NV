{{ define "main" }}
{{/* ===================== i18n mínimos inline (fallback) ===================== */}}
{{- $lang := .Site.Language.Lang | default "es" -}}
{{- $t := dict
  "contact_es" "Contacto"
  "contact_en" "Contact"
  "interests_es" "Intereses"
  "interests_en" "Interests"
  "education_es" "Educación"
  "education_en" "Education"
  "posts_es" "Publicaciones"
  "posts_en" "Posts"
  "blogpost_es" "Blogpost"
  "blogpost_en" "Blog posts"
  "org_es" "Organización"
  "org_en" "Organization"
-}}
{{- $LBL_contact    := cond (eq $lang "en") (index $t "contact_en") (index $t "contact_es") -}}
{{- $LBL_interests  := cond (eq $lang "en") (index $t "interests_en") (index $t "interests_es") -}}
{{- $LBL_education  := cond (eq $lang "en") (index $t "education_en") (index $t "education_es") -}}
{{- $LBL_posts      := cond (eq $lang "en") (index $t "blogpost_en") (index $t "blogpost_es") -}}

<article class="container mx-auto max-w-4xl px-6 md:px-10 xl:px-12 py-6 text-gray-900 dark:text-white">

  {{/* ================= Encabezado: responsive (columna en mobile / fila en desktop) ================ */}}
  <header class="mb-8 flex flex-col md:flex-row items-start md:items-center gap-5 md:gap-6">

    {{/* Avatar como Page Resource si es bundle; si no, cae a /authors/<slug>/avatar.png */}}
    {{- $avatar := cond (ne .File nil) (.Resources.GetMatch "avatar*") nil -}}

    {{/* Clave/slug del autor (para fallback de avatar y matching de posts) */}}
    {{- $authorKey := "" -}}
    {{- if .File -}}
      {{- $authorKey = ( .File.Dir | strings.TrimSuffix "/" | path.Base ) -}}
    {{- else -}}
      {{- $authorKey = ( .RelPermalink | strings.TrimSuffix "/" | path.Base ) -}}
    {{- end -}}

    {{/* Avatar: círculo, tamaños armónicos (mobile 10rem / desktop 15rem) */}}
    <div class="w-full md:w-auto flex md:block justify-center shrink-0">
      {{- if $avatar -}}
        <img src="{{ $avatar.RelPermalink }}" alt="{{ .Title }}"
             class="w-40 h-40 md:w-60 md:h-60 rounded-full object-cover" loading="lazy">
      {{- else -}}
        <img src="{{ printf "/authors/%s/avatar.png" $authorKey }}" alt="{{ .Title }}"
             class="w-40 h-40 md:w-60 md:h-60 rounded-full object-cover" loading="lazy">
      {{- end -}}
    </div>

    {{/* Columna derecha: nombre + metadatos */}}
    <div class="w-full">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight leading-tight">{{ .Title }}</h1>

      {{ with .Params.role }}
        <p class="text-sm opacity-80 mt-1">{{ . }}</p>
      {{ end }}

      {{ with .Params.organizations }}
        {{ range first 1 . }}
          {{ with .name }}<p class="text-sm opacity-80">{{ . }}</p>{{ end }}
        {{ end }}
      {{ end }}

      {{ with .Params.email }}
        <p class="text-sm mt-2">
          <a href="mailto:{{ . }}" class="underline break-all hover:no-underline">{{ . }}</a>
        </p>
      {{ end }}

      {{/* Redes sociales (íconos con Font Awesome si está disponible) */}}
      {{ $socials := .Params.social }}
      {{ if $socials }}
        {{/* etiquetas legibles por icono */}}
        {{ $labels := dict
          "twitter" "Twitter"
          "x-twitter" "Twitter"
          "github" "GitHub"
          "bluesky" "Bluesky"
          "linkedin" "LinkedIn"
          "mastodon" "Mastodon"
          "orcid" "ORCID"
          "globe" "Website"
          "home" "Website"
          "envelope" "Email"
        }}
        <p class="text-sm mt-2 flex flex-wrap items-center gap-x-3 gap-y-1">
          <span class="font-medium mr-1">{{ $LBL_contact }}:</span>
          {{ $items := slice }}
          {{ range $socials }}
            {{ $icon := ( .icon | lower ) }}
            {{ $pack := ( .icon_pack | lower ) }}
            {{ $url  := .link }}
            {{ $label := cond (isset $labels $icon) (index $labels $icon) (title $icon) }}
            {{/* fallback de pack */}}
            {{ $faPack := cond (eq $pack "fab") "fab" (cond (eq $pack "fas") "fas" "fab") }}
            {{/* accesible: aria-label en el <a> */}}
            {{ $one := printf `<a href="%s" target="_blank" rel="noopener" aria-label="%s" class="inline-flex items-center gap-1 underline hover:no-underline">
              <i class="%s fa-%s" aria-hidden="true"></i><span>%s</span>
            </a>` $url (printf "%s – %s" $label $.Title) $faPack $icon $label }}
            {{ $items = $items | append $one }}
          {{ end }}
          {{ delimit $items " · " | safeHTML }}
        </p>
      {{ end }}

      {{ with .Params.interests }}
        <p class="text-sm opacity-90 mt-2">
          <span class="font-medium">{{ $LBL_interests }}:</span> {{ delimit . " · " }}
        </p>
      {{ end }}

      {{/* Educación (lista corta, simple) */}}
      {{ with .Params.education }}
        {{ with .courses }}
          <div class="text-sm mt-3">
            <p class="font-medium mb-1">{{ $LBL_education }}:</p>
            <ul class="list-disc list-inside space-y-0.5">
              {{ range . }}
                <li>
                  {{- with .course -}}{{ . }}{{ end -}}
                  {{- if or .institution .year -}}
                    {{- if .institution }} – {{ .institution }}{{ end -}}
                    {{- if .year }} ({{ .year }}){{ end -}}
                  {{- end -}}
                </li>
              {{ end }}
            </ul>
          </div>
        {{ end }}
      {{ end }}
    </div>
  </header>

  {{/* ================= Contenido libre del autor (bio extendida en markdown) ================= */}}
  {{ if .Content }}
    <section class="prose dark:prose-invert max-w-none">
      {{ .Content }}
    </section>
  {{ end }}

  {{/* ================= Listado de posts (type: post) donde figure como autor ================= */}}
  {{/* Claves para matchear autor en .Params.authors: slug, Title, name param */}}
  {{ $keys := slice (lower $authorKey) (lower .Title) (lower (default "" .Params.name)) }}

  {{/* Recolectar páginas type=post donde este autor figure */}}
  {{ $col := slice }}
  {{ range where .Site.RegularPages "Type" "post" }}
    {{ $auth := .Params.authors }}
    {{ if $auth }}
      {{ $matched := false }}
      {{ $t := printf "%T" $auth }}
      {{ if eq $t "[]interface {}" }}
        {{ range $auth }}
          {{ $a := "" }}
          {{ if (eq (printf "%T" .) "map[string]interface {}") }}
            {{ if isset . "name" }}{{ $a = lower (printf "%v" (index . "name")) }}{{ end }}
            {{ if and (eq $a "") (isset . "title") }}{{ $a = lower (printf "%v" (index . "title")) }}{{ end }}
          {{ else }}
            {{ $a = lower (printf "%v" .) }}
          {{ end }}
          {{ if in $keys $a }}{{ $matched = true }}{{ end }}
        {{ end }}
      {{ else if eq $t "string" }}
        {{ if in $keys (lower $auth) }}{{ $matched = true }}{{ end }}
      {{ end }}
      {{ if $matched }}{{ $col = $col | append . }}{{ end }}
    {{ end }}
  {{ end }}
  {{ $pages := sort $col "Date" "desc" }}

  {{ if gt (len $pages) 0 }}
    <section class="mt-10">
      <h2 class="text-lg font-semibold mb-3">{{ $LBL_posts }}</h2>
      <ul class="list-disc list-inside space-y-1">
        {{ range $pages }}
          <li>
            <a href="{{ .RelPermalink }}" class="underline hover:no-underline">{{ .Title }}</a>
            {{ with .Date }}<span class="opacity-70 text-sm"> — {{ .Format "2006-01-02" }}</span>{{ end }}
          </li>
        {{ end }}
      </ul>
    </section>
  {{ end }}

</article>
{{ end }}
