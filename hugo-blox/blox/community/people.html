{{/* community/people.html — bloque People con filtro robusto por grupos

   Lee los grupos desde (en este orden):
   - .block.content.user_groups  (recomendado)
   - .block.user_groups          (fallback)
   - .block.content.group(s)     (fallback)
   - .block.group(s)             (fallback)
   Si no se pasó nada, usa el título del bloque como nombre de grupo (fallback).

   Toma autores desde la sección "authors" (incluye bundles con _index.md).
*/}}

{{ $b := .block }}
{{ $c := (index $b "content") | default dict }}
{{ $d := (index $b "design")  | default dict }}

{{/* Título/texto con fallback */}}
{{ $title := (index $c "title") | default (index $b "title") | default "" }}
{{ $text  := (index $c "text")  | default (index $b "text")  | default "" }}

{{/* Grupos solicitados (con múltiples llaves de fallback) */}}
{{ $wanted := (index $c "user_groups") }}
{{ if not $wanted }}{{ $wanted = (index $b "user_groups") }}{{ end }}
{{ if not $wanted }}{{ $wanted = (index $c "groups") }}{{ end }}
{{ if not $wanted }}{{ $wanted = (index $b "groups") }}{{ end }}
{{ if not $wanted }}{{ $wanted = (index $c "group") }}{{ end }}
{{ if not $wanted }}{{ $wanted = (index $b "group") }}{{ end }}

{{/* Si nada vino, usa el título del bloque como nombre de grupo */}}
{{ if not $wanted }}
  {{ $wanted = slice }}
  {{ if $title }}{{ $wanted = (slice $title) }}{{ end }}
{{ end }}

{{ $startOpen := (index $c "start_open") | default (index $b "start_open") | default false }}
{{ $columns   := (index $d "columns") | default 4 }}
{{ $compact   := (index $d "compact")  | default false }}

{{ $pad := cond $compact "py-6" "py-10" }}
{{ $colsClass := printf "md:grid-cols-%d" $columns }}

<section id="{{ (index $b "id") | default (anchorize $title) }}" class="{{ $pad }}">
  <div class="container mx-auto px-6 text-gray-900 dark:text-gray-100">
    <details {{ if $startOpen }}open{{ end }} class="group">
      <summary class="cursor-pointer select-none flex items-center justify-between gap-4 py-3">
        <div>
          {{ if $title }}<h2 class="text-2xl font-bold">{{ $title }}</h2>{{ end }}
          {{ if $text }}<div class="mt-1 opacity-80">{{ $text | markdownify }}</div>{{ end }}
        </div>
        <span class="text-sm opacity-70 group-open:rotate-180 transition">▾</span>
      </summary>

      {{/* Traer autores (incluye bundles) */}}
      {{ $all := where site.Pages "Section" "authors" }}

      {{/* Filtrar por intersección con grupos pedidos */}}
      {{ $sc := newScratch }}
      {{ $sc.Set "filtered" (slice) }}
      {{ range $all }}
        {{ $ug := .Params.user_groups | default (slice) }}
        {{ $common := intersect $ug $wanted }}
        {{ if gt (len $common) 0 }}
          {{ $sc.Add "filtered" (slice .) }}
        {{ end }}
      {{ end }}
      {{ $filtered := $sc.Get "filtered" }}

      {{ if gt (len $filtered) 0 }}
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 {{ $colsClass }} gap-6">
          {{ range sort $filtered "Title" }}
            <article class="rounded-xl border border-gray-200/60 dark:border-gray-700/60 p-4">
              <h3 class="font-semibold text-lg">{{ .Title }}</h3>
              {{ with .Params.role }}
                <p class="text-sm opacity-80 mt-1">{{ . }}</p>
              {{ end }}
              {{ with .Params.organizations }}
                <p class="text-sm opacity-80 mt-1">{{ delimit . ", " }}</p>
              {{ end }}
            </article>
          {{ end }}
        </div>
      {{ else }}
        <div class="mt-4 text-sm opacity-80">
          No se encontraron personas en los grupos:
          <code>{{ delimit $wanted ", " }}</code>.
        </div>
      {{ end }}
    </details>
  </div>
</section>
