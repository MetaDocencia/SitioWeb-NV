{{/* community/people.html — Bloque People robusto con filtro por grupos

   Lee los grupos desde (en este orden):
   - .block.content.user_groups
   - .block.user_groups
   - .block.content.groups
   - .block.groups
   - .block.content.group
   - .block.group
   Si no hay grupos, muestra un aviso claro y NO lista a todos por defecto.

   Obtiene autores desde la sección "authors".
*/}}

{{/* ---------- Inputs base ---------- */}}
{{ $b := .block }}
{{ $c := (index $b "content") | default dict }}
{{ $d := (index $b "design")  | default dict }}

{{/* Título y texto (con fallback al nivel raíz del bloque) */}}
{{ $title := (index $c "title") | default (index $b "title") | default "Personas" }}
{{ $text  := (index $c "text")  | default (index $b "text")  | default "" }}

{{/* Grupos solicitados, tolerantes a variantes */}}
{{ $wanted := (index $c "user_groups") }}
{{ if not $wanted }}{{ $wanted = (index $b "user_groups") }}{{ end }}
{{ if not $wanted }}{{ $wanted = (index $c "groups") }}{{ end }}
{{ if not $wanted }}{{ $wanted = (index $b "groups") }}{{ end }}
{{ if not $wanted }}{{ $wanted = (index $c "group") }}{{ end }}
{{ if not $wanted }}{{ $wanted = (index $b "group") }}{{ end }}

{{/* Normalizar: si vino un string, convertirlo a slice */}}
{{ if and $wanted (not (or (isArray $wanted) (isSlice $wanted))) }}
  {{ $wanted = (slice (printf "%v" $wanted)) }}
{{ end }}
{{ if not $wanted }}{{ $wanted = slice }}{{ end }}

{{/* Diseño */}}
{{ $columns   := (index $d "columns") | default 4 }}
{{ $compact   := (index $d "compact")  | default false }}
{{ $startOpen := (index $c "start_open") | default (index $b "start_open") | default false }}

{{ $pad := cond $compact "py-6" "py-10" }}
{{ $colsClass := printf "md:grid-cols-%d" $columns }}

<section id="{{ (index $b "id") | default (anchorize $title) }}" class="{{ $pad }}">
  <div class="container mx-auto px-6 text-gray-900 dark:text-gray-100">
    <details class="group rounded-2xl border border-gray-200/70 dark:border-gray-700/70 bg-white dark:bg-gray-900" {{ if $startOpen }}open{{ end }}>
      <summary class="flex items-center justify-between cursor-pointer p-4">
        <div class="min-w-0">
          <h2 class="text-2xl font-bold">{{ $title }}</h2>
          {{ if $text }}
            <div class="text-gray-600 dark:text-gray-300 mt-1">{{ $text | markdownify }}</div>
          {{ end }}
        </div>
        <span aria-hidden="true" class="ml-4 select-none text-xl leading-none">▾</span>
      </summary>

      <div class="px-4 pb-6">
        {{ if eq (len $wanted) 0 }}
          <div class="mt-2 text-sm opacity-80">
            No se definió ningún grupo en este bloque. Agregá <code>content.user_groups</code> en la página.
          </div>
        {{ else }}
          {{/* Traer autores de la sección "authors" */}}
          {{ $all := where site.Pages "Section" "authors" }}

          {{/* Filtrar por intersección con los grupos pedidos */}}
          {{ $sc := newScratch }}
          {{ $sc.Set "filtered" (slice) }}
          {{ range $all }}
            {{ $ug := .Params.user_groups | default (slice) }}
            {{ $common := intersect $ug $wanted }}
            {{ if gt (len $common) 0 }}
              {{ $sc.Add "filtered" (slice .) }}
            {{ end }}
          {{ end }}
          {{ $filtered := $sc.Get "filtered" }}

          {{ if gt (len $filtered) 0 }}
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 {{ $colsClass }} gap-6">
              {{ range sort $filtered "Title" }}
                <article class="rounded-xl border border-gray-200/60 dark:border-gray-700/60 p-4 hover:shadow transition">
                  <h3 class="font-semibold text-lg">{{ .Title }}</h3>
                  {{ with .Params.role }}<div class="text-sm opacity-80 mt-1">{{ . }}</div>{{ end }}
                  {{ with (index .Params "organizations") }}
                    {{ with (index . 0) }}
                      {{ with .name }}<div class="text-sm opacity-80 mt-1">{{ . }}</div>{{ end }}
                    {{ end }}
                  {{ end }}
                </article>
              {{ end }}
            </div>
          {{ else }}
            <div class="mt-2 text-sm opacity-80">
              No se encontraron personas en los grupos:
              <code>{{ delimit $wanted ", " }}</code>.
            </div>
          {{ end }}
        {{ end }}
      </div>
    </details>
  </div>
</section>
